<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- USER SETTINGS (placeholder) ---
        const userSettings = {
            minProfitMargin: 0.50, // 50%
            platformFee: 0.15,     // 15%
            shippingCost: 8.00     // $8
        };
        
        // This function calculates the max price you should pay
        function calculateWorthPaying(avgSalePrice) {
            const profit = avgSalePrice * userSettings.minProfitMargin;
            const fees = avgSalePrice * userSettings.platformFee;
            return avgSalePrice - fees - userSettings.shippingCost - profit;
        }
        
        function displayScanResult(data) {
            // The API now sends pre-analyzed data in `conditionAnalysis`
            const analysis = data.conditionAnalysis;

            document.getElementById('itemName').textContent = data.productName;
            document.getElementById('itemImage').src = data.imageUrl;

            const scoreText = document.getElementById('powerScore');
            const scoreBadge = document.getElementById('powerScoreBadge');
            scoreText.textContent = data.powerScore;
            
            if (data.powerScore >= 90) { scoreBadge.src = 'icons/gold-badge.png'; }
            else if (data.powerScore >= 70) { scoreBadge.src = 'icons/green-badge.png'; }
            else if (data.powerScore >= 50) { scoreBadge.src = 'icons/blue-badge.png'; }
            else { scoreBadge.src = 'icons/red-badge.png'; }

            const conditionContainer = document.getElementById('conditionAnalysis');
            conditionContainer.innerHTML = '';
            
            // Define the order for display
            const conditionOrder = ['New', 'Used', 'For parts'];

            conditionOrder.forEach(cond => {
                if (analysis[cond]) {
                    const worth = calculateWorthPaying(analysis[cond].avgPrice);
                    conditionContainer.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-700/50 p-3 rounded-md">
                            <div>
                                <p class="font-semibold text-white">${cond}</p>
                                <p class="text-xs text-slate-400">Buy under <span class="font-bold text-yellow-400">$${worth > 0 ? worth.toFixed(2) : '0.00'}</span></p>
                            </div>
                            <p class="text-lg font-bold text-green-400">$${analysis[cond].avgPrice.toFixed(2)}</p>
                        </div>
                    `;
                }
            });

            // The rest of your UI logic for buttons, etc.
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');
        }

        // --- API Call Logic ---
        const imageData = localStorage.getItem('pendingScanImage');
        if (imageData) {
            const response = await fetch(imageData);
            const blob = await response.blob();
            const file = new File([blob], 'scan.jpg', { type: 'image/jpeg' });
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                // Call your Vercel serverless function
                const apiResponse = await fetch('/api/scan', {
                    method: 'POST',
                    body: formData
                });
                
                if (apiResponse.ok) {
                    const resultData = await apiResponse.json();
                    displayScanResult(resultData);
                } else {
                    // Handle API errors (like low confidence)
                    const errorData = await apiResponse.json();
                    alert(`Analysis failed: ${errorData.error || 'Please try again.'}`);
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("API call failed:", error);
                alert("There was an issue analyzing the image. Displaying sample data.");
                // displayScanResult(mockScanData); // You can keep your mock data for fallback
            } finally {
                localStorage.removeItem('pendingScanImage');
            }
        } else {
            alert("No image data found. Redirecting home.");
            window.location.href = 'index.html';
        }
    });
</script>