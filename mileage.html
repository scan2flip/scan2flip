<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0d1f2d">
    <title>Mileage Tracker - Scan2Flip</title>
    
    <link rel="icon" type="image/png" href="/icons/scan2flip-logo.png">
    <link rel="apple-touch-icon" href="/icons/scan2flip-logo.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <img src="/icons/scan2flip-logo.png" alt="Scan2Flip" style="width: 48px; height: 48px;">
                <div class="logo-text">SCAN2FLIP</div>
            </div>
            <div class="header-stats">
                <div class="scan-counter" id="scanCounter">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zM13 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1V4zM13 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-3z"/>
                    </svg>
                    <span id="scanCount">5/5 Daily</span>
                </div>
                <div class="scan-pack-badge" id="scanPackBadge" style="display: none;">
                    +<span id="packCount">0</span> packs
                </div>
            </div>
        </header>

        <div class="page-content">
            <div style="padding: 1.5rem;">
                <div class="result-header">
                    <a href="index.html" class="back-button">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <h2 style="font-size: 1.25rem; font-weight: 600;">Mileage Tracker</h2>
                    <div style="width: 24px;"></div>
                </div>
                
                <div class="stats-grid" style="margin-top: 2rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyMiles">0</div>
                        <div class="stat-label">Miles This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mileageDeduction">$0.00</div>
                        <div class="stat-label">Tax Deduction</div>
                    </div>
                </div>
                
                <div id="activeTripTracker" style="display: none; background: var(--bg-tertiary); border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--accent-green); font-weight: 700;">üî¥ TRACKING ACTIVE</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">Started: <span id="tripStartTime"></span></div>
                        </div>
                        <button class="btn btn-danger" onclick="endMileageTracking()">End Trip</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
                    <button id="gpsTripBtn" class="btn btn-success" onclick="startMileageTracking()">üìç Start GPS Trip</button>
                    <button class="btn btn-primary" onclick="quickAddMileage()">‚ûï Add Manual Trip</button>
                </div>
                
                <div id="tripList"></div>
            </div>
        </div>

        <nav class="bottom-nav">
            <a class="nav-item" href="index.html">
                <img src="/icons/home.png" alt="Home">
                <span>Home</span>
            </a>
            <a class="nav-item" href="inventory.html">
                <img src="/icons/inventory.png" alt="Inventory">
                <span>Inventory</span>
            </a>
            <a class="nav-item" href="expenses.html">
                <img src="/icons/dollar.png" alt="Expenses">
                <span>Expenses</span>
            </a>
            <a class="nav-item active" href="mileage.html">
                <img src="/icons/mileage.png" alt="Mileage">
                <span>Mileage</span>
            </a>
            <a class="nav-item" href="scores.html">
                <img src="/icons/powerscore.png" alt="History">
                <span>Scores</span>
            </a>
            <a class="nav-item" href="more.html">
                <img src="/icons/coins.png" alt="More">
                <span>More</span>
            </a>
        </nav>
    </div>

    <div class="toast" id="toast"></div>

    <script src="app.js"></script>
    <script>
        let activeTrip = null;

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            updateMileageStats();
            displayRecentTrips();
            updateActiveTripUI();
        });

        function startMileageTracking() {
            if (!requireTier('pro', 'Mileage tracking')) return;
            
            if (activeTrip) {
                showToast('Trip already in progress!', 'error');
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        activeTrip = {
                            startTime: new Date(),
                            startLat: position.coords.latitude,
                            startLng: position.coords.longitude,
                        };
                        updateActiveTripUI();
                        showToast('GPS trip tracking started!', 'success');
                    },
                    (error) => {
                        showToast('Could not get location. Please enable GPS.', 'error');
                    }
                );
            } else {
                showToast('Geolocation is not supported by this browser.', 'error');
            }
        }

        function endMileageTracking() {
            if (!activeTrip) return;
            
            if (navigator.geolocation && activeTrip.startLat) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const distance = calculateDistance(
                            activeTrip.startLat, activeTrip.startLng,
                            position.coords.latitude, position.coords.longitude
                        );
                        saveMileageTrip(distance, 'GPS Tracked');
                    },
                    () => {
                        promptForManualMileage();
                    }
                );
            } else {
                promptForManualMileage();
            }
        }
        
        function promptForManualMileage() {
            const miles = prompt('Could not calculate distance. Please enter miles driven for this trip:');
            if (miles && !isNaN(miles)) {
                saveMileageTrip(parseFloat(miles), 'Manual Entry');
            } else {
                activeTrip = null;
                updateActiveTripUI();
            }
        }

        function saveMileageTrip(miles, method) {
            if (!state.mileageTrips) state.mileageTrips = [];
            const trip = {
                id: Date.now(),
                date: activeTrip.startTime.toISOString(),
                miles: parseFloat(miles.toFixed(2)),
                deduction: (miles * IRS_MILEAGE_RATE).toFixed(2),
                method: method,
                notes: ''
            };
            state.mileageTrips.push(trip);
            activeTrip = null;
            updateActiveTripUI();
            updateMileageStats();
            displayRecentTrips();
            saveState();
            showToast(`Trip saved: ${trip.miles} miles ($${trip.deduction} deduction)`, 'success');
        }
        
        function updateActiveTripUI() {
            const tracker = document.getElementById('activeTripTracker');
            const gpsBtn = document.getElementById('gpsTripBtn');
            if (activeTrip) {
                tracker.style.display = 'block';
                document.getElementById('tripStartTime').textContent = activeTrip.startTime.toLocaleTimeString();
                gpsBtn.style.display = 'none';
            } else {
                tracker.style.display = 'none';
                gpsBtn.style.display = 'block';
            }
        }

        function quickAddMileage() {
            if (!requireTier('pro', 'Mileage tracking')) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Add Manual Trip</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="quick-miles-date" class="form-input" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Miles Driven</label>
                        <input type="number" id="quick-miles-amount" class="form-input" placeholder="e.g. 25.5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trip Purpose (Optional)</label>
                        <input type="text" id="quick-miles-notes" class="form-input" placeholder="e.g. Goodwill + estate sales">
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Tax Deduction:</span>
                            <span id="quick-deduction" style="color: var(--accent-green); font-weight: 600;">$0.00</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveQuickMileage()">Save Trip</button>
                </div>`;
            document.body.appendChild(modal);
            
            document.getElementById('quick-miles-amount').addEventListener('input', (e) => {
                const miles = parseFloat(e.target.value) || 0;
                document.getElementById('quick-deduction').textContent = `$${(miles * IRS_MILEAGE_RATE).toFixed(2)}`;
            });
        }

        function saveQuickMileage() {
            const date = document.getElementById('quick-miles-date').value;
            const miles = parseFloat(document.getElementById('quick-miles-amount').value);
            const notes = document.getElementById('quick-miles-notes').value;
            
            if (!miles || miles <= 0) {
                showToast('Please enter valid mileage', 'error');
                return;
            }
            
            if (!state.mileageTrips) state.mileageTrips = [];
            const trip = { 
                id: Date.now(), 
                date: new Date(date).toISOString(), 
                miles: miles, 
                deduction: (miles * IRS_MILEAGE_RATE).toFixed(2), 
                notes: notes, 
                method: 'Manual' 
            };
            state.mileageTrips.push(trip);
            saveState();
            document.querySelector('.modal-overlay').remove();
            updateMileageStats();
            displayRecentTrips();
            showToast(`Added ${miles} miles ($${trip.deduction} deduction)`, 'success');
        }

        function updateMileageStats() {
            if (!state.mileageTrips) state.mileageTrips = [];
            const now = new Date();
            const monthTrips = state.mileageTrips.filter(trip => {
                const tripDate = new Date(trip.date);
                return tripDate.getMonth() === now.getMonth() && tripDate.getFullYear() === now.getFullYear();
            });
            const totalMiles = monthTrips.reduce((sum, trip) => sum + trip.miles, 0);
            const totalDeduction = totalMiles * IRS_MILEAGE_RATE;
            document.getElementById('monthlyMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('mileageDeduction').textContent = `$${totalDeduction.toFixed(2)}`;
        }
        
        function displayRecentTrips() {
            const container = document.getElementById('tripList');
            if (!state.mileageTrips || state.mileageTrips.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-title">No Trips Logged</div><div class="empty-text">Track your drives for sourcing and shipping.</div></div>';
                return;
            }
            const recentTrips = [...state.mileageTrips].reverse();
            container.innerHTML = recentTrips.map(trip => `
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${trip.miles} miles <span style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 400;">(${trip.method})</span></div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${new Date(trip.date).toLocaleDateString()} ${trip.notes ? ` - ${trip.notes}` : ''}</div>
                        </div>
                        <div style="color: var(--accent-green); font-weight: 600;">$${trip.deduction}</div>
                    </div>
                </div>`).join('');
        }
    </script>
</body>
</html>