<script>
    // This function is still needed to create a File object for the API call
    function dataUrlToFile(dataUrl, fileName) {
        const arr = dataUrl.split(',');
        const mimeMatch = arr[0].match(/:(.*?);/);
        if (!mimeMatch) { return null; }
        const mime = mimeMatch[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        const blob = new Blob([u8arr], { type: mime });
        return new File([blob], fileName, { type: mime });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const settings = JSON.parse(localStorage.getItem('scan2flip-settings')) || { profitMargin: 0.50, platformFee: 0.15, shippingCost: 8.00 };
        
        function calculateWorthPaying(avgSalePrice) {
            const profit = avgSalePrice * settings.profitMargin;
            const fees = avgSalePrice * settings.platformFee;
            const worth = avgSalePrice - fees - settings.shippingCost - profit;
            return worth > 0 ? worth.toFixed(2) : '0.00';
        }
        
        function displayScanResult(data) {
            const analysis = data.soldListings || {}; 
            
            document.getElementById('itemName').textContent = data.productName;
            document.getElementById('itemImage').src = data.imageUrl;
            document.getElementById('powerScore').textContent = data.powerScore;

            const scoreBadge = document.getElementById('powerScoreBadge');
            if (data.powerScore >= 90) { scoreBadge.src = 'icons/gold-badge.png'; }
            else if (data.powerScore >= 70) { scoreBadge.src = 'icons/green-badge.png'; }
            else if (data.powerScore >= 50) { scoreBadge.src = 'icons/blue-badge.png'; }
            else { scoreBadge.src = 'icons/red-badge.png'; }

            const conditionContainer = document.getElementById('conditionAnalysis');
            conditionContainer.innerHTML = '';
            
            const conditionOrder = ['New', 'Used', 'For parts'];
            let conditionsFound = 0;
            
            conditionOrder.forEach(cond => {
                if (analysis[cond] && analysis[cond].count > 0) {
                    conditionsFound++;
                    const worth = calculateWorthPaying(analysis[cond].avgPrice);
                    const avgPriceFormatted = analysis[cond].avgPrice.toFixed(2);
                    conditionContainer.innerHTML += `<div class="flex justify-between items-center bg-slate-700/50 p-3 rounded-md"><div><p class="font-semibold text-white">${cond}</p><p class="text-xs text-slate-400">Buy under <span class="font-bold text-yellow-400">$${worth}</span></p></div><p class="text-lg font-bold text-green-400">$${avgPriceFormatted}</p></div>`;
                }
            });

            if (conditionsFound === 0) {
                conditionContainer.innerHTML = `<p class="text-center text-slate-400">No recent sales data found to determine value.</p>`;
            }

            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');
            document.getElementById('leaveItBtn').onclick = () => window.location.href = 'index.html';
            document.getElementById('keepItBtn').onclick = () => window.location.href = 'index.html'; 
        }

        const imageData = localStorage.getItem('pendingScanImage');
        if (imageData) {
            try {
                const file = dataUrlToFile(imageData, 'scan.jpg');
                if (!file) throw new Error("Could not convert image data.");
                
                const formData = new FormData();
                formData.append('image', file);
                
                const apiResponse = await fetch('/api/scan', { method: 'POST', body: formData });
                
                if (apiResponse.ok) {
                    const resultData = await apiResponse.json();
                    displayScanResult(resultData);
                } else {
                    const errorData = await apiResponse.json();
                    throw new Error(errorData.error || `Server responded with status: ${apiResponse.status}`);
                }
            } catch (error) {
                console.error("API call process failed:", error);
                const mockData = {"productName":"API Call Failed","imageUrl":"icons/red-badge.png","powerScore":0,"soldListings":{},"sellThroughRate":0,"activeListings":0};
                displayScanResult(mockData);
            } finally {
                localStorage.removeItem('pendingScanImage');
            }
        } else {
            window.location.href = 'index.html';
        }
    });
</script>